{"version":3,"file":"index.es.js","sources":["../src/engine.ts","../src/coroutine.ts"],"sourcesContent":["import { EventEmitter } from 'events';\nimport Coroutine from './coroutine';\n\ndeclare global {\n    interface Window {\n        requestIdleCallback: Function;\n    }\n}\n\nclass Engine extends EventEmitter {\n    private coroutine: Set<Coroutine>;\n    private continues: Function[];\n\n    constructor() {\n        super();\n        this.coroutine = new Set();\n        this.continues = [];\n\n        this.on('add', (cor) => {\n            this.coroutine.add(cor);\n        })\n\n        this.on('delete', (cor) => {\n            this.coroutine.delete(cor);\n        })\n\n        this.on('continue', (_continue) => {\n            this.continues.push(_continue);\n            this.continue();\n        })\n    }\n\n    private continue = () => {\n        const _continue = this.continues.shift();\n        if (typeof window !== 'undefined' && window.requestIdleCallback) {\n            window.requestIdleCallback(_continue);\n        } else {\n            _continue();\n        }\n    }\n\n    public getCoroutines = () => {\n        return this.coroutine;\n    }\n}\n\nexport default new Engine();\n","import engine from './engine';\n\ninterface Config {\n    name?: string;\n    isStart?: boolean;\n}\n\ninterface CoTools {\n    sleep?: Function;\n    coSwitch?: Function;\n    park: Function;\n}\n\ntype coBlock = (coTools: CoTools) => Promise<void>;\n\nenum Status {\n    NEW = 'NEW',\n    RUNNING = 'RUNNING',\n    WAITING = 'WAITING',\n    DONE = 'DONE'\n}\n\nclass Coroutine {\n    private status: Status;\n    private id: string;\n    private name: string;\n    private coBlock: coBlock;\n\n    static getCoroutines = () => {\n        return engine.getCoroutines();\n    }\n\n    constructor(coBlock: coBlock, config?: Config) {\n        this.status = Status.NEW;\n        this.name = config && config.name;\n        this.coBlock = coBlock;\n        engine.emit('add', this);\n        config && config.isStart && this.run();\n    }\n\n    public start = () => {\n        this.run();\n    }\n\n    private run = async () => {\n        if (this.status === Status.RUNNING) return;\n\n        this.status = Status.RUNNING;\n        const sleep = this.sleep;\n        const coSwitch = this.coSwitch;\n        const park = this.park;\n\n        await this.coBlock({\n            sleep, coSwitch, park\n        });\n\n        this.status = Status.DONE;\n        engine.emit('delete', this);\n    }\n\n    private coSwitch = () => {\n        this.status = Status.WAITING;\n        return new Promise(resolve => {\n            engine.emit('continue', () => {\n                resolve();\n                this.status = Status.RUNNING;\n            })\n        });\n    }\n\n    private sleep = (t = 0) => {\n        this.status = Status.WAITING;\n        return new Promise(resolve => {\n            setTimeout(() => {\n                resolve();\n                this.status = Status.RUNNING;\n            }, t);\n        })\n    }\n\n    private park = () => {\n        this.status = Status.WAITING;\n        return new Promise(() => { });\n    }\n\n}\n\nexport {\n    Coroutine as default,\n    Coroutine\n}\n"],"names":[],"mappings":"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"}